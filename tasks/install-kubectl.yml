---
- name: Extract kubectl path and register var
  set_fact: kubectl_bin_path={{ item.path }}
  with_items:
    "{{ kubernetes_tools }}"
  when: '"kubectl" in item.name'

- name: Remove kubectl app
  file:
    path: "{{ kubectl_bin_path }}"
    state: absent
  when: uninstall_tools

- name: Check if kubectl binary exists.
  stat:
    path: "{{ kubectl_bin_path }}"
  register: kubectl_check

- name: Check kubectl version.
  command: "{{ kubectl_bin_path }} version --client"
  failed_when: false
  changed_when: false
  register: kubectl_existing_version

- name: Detect host architecture and set facts
  set_fact: k8s_arch="amd64" kubectl_arch="amd64"
  register: detected_arch
  when: ansible_facts.architecture == "x86_64"

- name: Show detected arch
  debug: msg="{{ detected_arch }}"
  failed_when: false

- name: Download kubectl binary
  get_url:
    url: "https://dl.k8s.io/release/v{{ kubectl_version }}/bin/{{ k8s_platform }}/{{ k8s_arch }}/kubectl"
    checksum: "{{ kubectl_checksum_binary }}"
    dest: /tmp
  when: >
    (not kubectl_check.stat.exists or kubectl_version not in kubectl_existing_version.stdout)
    and uninstall_tools
  notify: copy kubectl binary
